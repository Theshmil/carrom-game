<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carrom Game</title>
<style>
  body {
    background: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
  }
  canvas {
    background: #deb887;
    margin-top: 10px;
    touch-action: none;
  }
  #menu, #win {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #222;
    border: 2px solid #555;
    padding: 30px;
    border-radius: 10px;
  }
  #menu button, #win button {
    margin: 10px;
    padding: 15px 25px;
    background: #fff;
    color: #000;
    font-size: 1.2em;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #score {
    margin-top: 10px;
    font-size: 1.2em;
  }
</style>
</head>
<body>

<h1>Carrom Game</h1>
<div id="menu">
  <h2>Choose Mode</h2>
  <button onclick="startGame('local')">Local Multiplayer</button>
  <button onclick="startGame('ai')">Play vs AI</button>
</div>

<canvas id="canvas" width="400" height="400" style="display:none"></canvas>
<div id="score" style="display:none">Score: 0</div>

<div id="win" style="display:none">
  <h2>You Win!</h2>
  <button onclick="restartGame()">Restart</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const menuEl = document.getElementById('menu');
const winEl = document.getElementById('win');

let striker, coins, allBalls, score, dragging, dragStart, gameMode;

function startGame(mode){
  gameMode = mode;
  score=0;
  striker = { x: 200, y: 350, radius: 12, dx:0, dy:0, color:'#fff', border:'#003366' };
  coins = [];

  // Red coin in center
  coins.push({ x:200, y:200, radius:10, dx:0, dy:0, color:'red' });

  // Arrange 9 coins in circle
  let colors = ['white','white','white','white','#000','#000','#000','#000','white'];
  let angleStep = (2*Math.PI)/colors.length;
  let r=25;
  for(let i=0;i<colors.length;i++){
    let angle = i*angleStep;
    coins.push({ x:200+Math.cos(angle)*r, y:200+Math.sin(angle)*r, radius:10, dx:0, dy:0, color:colors[i] });
  }

  allBalls = [striker, ...coins];
  dragging = false;
  menuEl.style.display='none';
  winEl.style.display='none';
  canvas.style.display='block';
  scoreEl.style.display='block';
  loop();
}

function restartGame(){
  startGame(gameMode);
}

// Support mouse and touch
function getPos(e){
  if(e.touches) return { x: e.touches[0].clientX - canvas.getBoundingClientRect().left, y: e.touches[0].clientY - canvas.getBoundingClientRect().top };
  else return { x: e.offsetX, y: e.offsetY };
}

canvas.addEventListener('mousedown', startDrag);
canvas.addEventListener('mousemove', dragMove);
canvas.addEventListener('mouseup', endDrag);
canvas.addEventListener('touchstart', startDrag, {passive: false});
canvas.addEventListener('touchmove', dragMove, {passive: false});
canvas.addEventListener('touchend', endDrag);

function startDrag(e){
  e.preventDefault();
  const pos = getPos(e);
  if(Math.hypot(pos.x - striker.x, pos.y - striker.y) < striker.radius+10){
    dragging = true;
    dragStart = pos;
  }
}
function dragMove(e){
  if(dragging){
    e.preventDefault();
    dragStart = getPos(e);
  }
}
function endDrag(e){
  if(dragging){
    e.preventDefault();
    dragging = false;
    const pos = getPos(e);
    let dx = striker.x - pos.x;
    let dy = striker.y - pos.y;
    let length = Math.hypot(dx, dy);
    let force = Math.min(length/10, 6);
    striker.dx = (dx/length)*force;
    striker.dy = (dy/length)*force;
  }
}

function collide(b1, b2){
  let dx=b2.x-b1.x;
  let dy=b2.y-b1.y;
  let dist=Math.hypot(dx,dy);
  let minDist=b1.radius+b2.radius;
  if(dist<minDist && dist>0){
    let overlap = (minDist - dist) / 2;
    let nx = dx/dist;
    let ny = dy/dist;
    b1.x -= nx*overlap;
    b1.y -= ny*overlap;
    b2.x += nx*overlap;
    b2.y += ny*overlap;

    let vx=b1.dx - b2.dx;
    let vy=b1.dy - b2.dy;
    let dot= vx*nx + vy*ny;
    b1.dx -= dot*nx;
    b1.dy -= dot*ny;
    b2.dx += dot*nx;
    b2.dy += dot*ny;
  }
}

function update() {
  allBalls.forEach(ball=>{
    ball.x += ball.dx;
    ball.y += ball.dy;
    ball.dx *=0.98;
    ball.dy *=0.98;
    if(Math.abs(ball.dx)<0.05) ball.dx=0;
    if(Math.abs(ball.dy)<0.05) ball.dy=0;

    if(ball.x - ball.radius < 0){ ball.x=ball.radius; ball.dx=-ball.dx; }
    if(ball.x + ball.radius > 400){ ball.x=400-ball.radius; ball.dx=-ball.dx; }
    if(ball.y - ball.radius < 0){ ball.y=ball.radius; ball.dy=-ball.dy; }
    if(ball.y + ball.radius > 400){ ball.y=400-ball.radius; ball.dy=-ball.dy; }
  });

  for(let i=0;i<allBalls.length;i++){
    for(let j=i+1;j<allBalls.length;j++){
      collide(allBalls[i], allBalls[j]);
    }
  }

  let pockets = [[0,0],[400,0],[0,400],[400,400]];
  coins = coins.filter(c=>{
    let pocketed=false;
    pockets.forEach(p=>{
      if(Math.hypot(c.x-p[0],c.y-p[1])<28){ pocketed=true; score+=1; }
    });
    return !pocketed;
  });
  allBalls = [striker, ...coins];
  scoreEl.innerText="Score: "+score;

  if(coins.length===0){
    canvas.style.display='none';
    scoreEl.style.display='none';
    winEl.style.display='block';
  }
}

function drawBoard(){
  ctx.clearRect(0,0,400,400);
  ctx.fillStyle='#deb887';
  ctx.fillRect(0,0,400,400);

  ctx.strokeStyle='#8b4513';
  ctx.lineWidth=6;
  ctx.strokeRect(10,10,380,380);

  ctx.strokeStyle='#654321';
  ctx.lineWidth=3;
  ctx.strokeRect(40,40,320,320);

  ctx.beginPath();
  ctx.arc(200,200,20,0,Math.PI*2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(200,40); ctx.lineTo(200,360);
  ctx.moveTo(40,200); ctx.lineTo(360,200);
  ctx.stroke();

  ctx.fillStyle='#000';
  [[0,0],[400,0],[0,400],[400,400]].forEach(p=>{
    ctx.beginPath();
    ctx.arc(p[0],p[1],28,0,Math.PI*2);
    ctx.fill();
  });
}

function draw(){
  drawBoard();
  coins.forEach(c=>{
    ctx.beginPath();
    ctx.arc(c.x,c.y,c.radius,0,Math.PI*2);
    ctx.fillStyle=c.color;
    ctx.fill();
  });
  ctx.beginPath();
  ctx.arc(striker.x,striker.y,striker.radius,0,Math.PI*2);
  ctx.fillStyle=striker.color;
  ctx.fill();
  ctx.lineWidth=2;
  ctx.strokeStyle=striker.border;
  ctx.stroke();

  if(dragging){
    ctx.strokeStyle='cyan';
    ctx.beginPath();
    ctx.moveTo(striker.x,striker.y);
    ctx.lineTo(dragStart.x,dragStart.y);
    ctx.stroke();
  }
}

function loop(){
  if(coins.length>0){
    update();
    draw();
    requestAnimationFrame(loop);
  }
}
</script>
</body>
</html>